#!/usr/bin/env node

/**
 * Validates .env.local file format and required variables
 * Run this script to check your environment configuration
 */

require('dotenv').config({ path: '.env.local' })

const requiredVars = [
  'NEXTAUTH_URL',
  'NEXTAUTH_SECRET',
  'GOOGLE_CLIENT_ID',
  'GOOGLE_CLIENT_SECRET',
  'NEXT_PUBLIC_SUPABASE_URL',
  'NEXT_PUBLIC_SUPABASE_ANON_KEY',
  'SUPABASE_SERVICE_ROLE_KEY',
]

const issues = []
const warnings = []

console.log('üîç Validating .env.local configuration...\n')

// Check NEXTAUTH_URL
const nextAuthUrl = process.env.NEXTAUTH_URL
if (!nextAuthUrl) {
  issues.push('‚ùå NEXTAUTH_URL is missing')
} else {
  const trimmed = nextAuthUrl.trim()
  if (trimmed !== 'http://localhost:3000') {
    issues.push(`‚ùå NEXTAUTH_URL should be exactly "http://localhost:3000" but found: "${trimmed}"`)
  } else if (nextAuthUrl !== trimmed) {
    warnings.push(`‚ö†Ô∏è  NEXTAUTH_URL has leading/trailing spaces: "${nextAuthUrl}"`)
  } else {
    console.log('‚úÖ NEXTAUTH_URL is correct: http://localhost:3000')
  }
  
  // Check for common mistakes
  if (nextAuthUrl.includes(' ')) {
    issues.push('‚ùå NEXTAUTH_URL contains spaces (remove spaces around =)')
  }
  if (nextAuthUrl.startsWith('"') || nextAuthUrl.startsWith("'")) {
    issues.push('‚ùå NEXTAUTH_URL has quotes (remove quotes)')
  }
  if (nextAuthUrl.endsWith('/')) {
    issues.push('‚ùå NEXTAUTH_URL has trailing slash (remove trailing slash)')
  }
}

// Check NEXTAUTH_SECRET
const nextAuthSecret = process.env.NEXTAUTH_SECRET
if (!nextAuthSecret) {
  issues.push('‚ùå NEXTAUTH_SECRET is missing')
} else {
  const trimmed = nextAuthSecret.trim()
  if (nextAuthSecret !== trimmed) {
    warnings.push(`‚ö†Ô∏è  NEXTAUTH_SECRET has leading/trailing spaces`)
  } else {
    console.log('‚úÖ NEXTAUTH_SECRET exists')
  }
  
  if (trimmed.length < 32) {
    warnings.push('‚ö†Ô∏è  NEXTAUTH_SECRET should be at least 32 characters long')
  }
}

// Check Google OAuth
const googleClientId = process.env.GOOGLE_CLIENT_ID
const googleClientSecret = process.env.GOOGLE_CLIENT_SECRET

if (!googleClientId) {
  issues.push('‚ùå GOOGLE_CLIENT_ID is missing')
} else {
  const trimmed = googleClientId.trim()
  if (googleClientId !== trimmed) {
    warnings.push(`‚ö†Ô∏è  GOOGLE_CLIENT_ID has leading/trailing spaces`)
  } else {
    console.log('‚úÖ GOOGLE_CLIENT_ID exists')
  }
}

if (!googleClientSecret) {
  issues.push('‚ùå GOOGLE_CLIENT_SECRET is missing')
} else {
  const trimmed = googleClientSecret.trim()
  if (googleClientSecret !== trimmed) {
    warnings.push(`‚ö†Ô∏è  GOOGLE_CLIENT_SECRET has leading/trailing spaces`)
  } else {
    console.log('‚úÖ GOOGLE_CLIENT_SECRET exists')
  }
}

// Check Supabase variables
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY

if (!supabaseUrl) {
  issues.push('‚ùå NEXT_PUBLIC_SUPABASE_URL is missing')
} else {
  const trimmed = supabaseUrl.trim()
  if (supabaseUrl !== trimmed) {
    issues.push('‚ùå NEXT_PUBLIC_SUPABASE_URL has leading/trailing spaces')
  } else {
    console.log('‚úÖ NEXT_PUBLIC_SUPABASE_URL exists (no spaces)')
  }
}

if (!supabaseAnonKey) {
  issues.push('‚ùå NEXT_PUBLIC_SUPABASE_ANON_KEY is missing')
} else {
  const trimmed = supabaseAnonKey.trim()
  if (supabaseAnonKey !== trimmed) {
    issues.push('‚ùå NEXT_PUBLIC_SUPABASE_ANON_KEY has leading/trailing spaces')
  } else {
    console.log('‚úÖ NEXT_PUBLIC_SUPABASE_ANON_KEY exists (no spaces)')
  }
}

if (!supabaseServiceKey) {
  issues.push('‚ùå SUPABASE_SERVICE_ROLE_KEY is missing')
} else {
  const trimmed = supabaseServiceKey.trim()
  if (supabaseServiceKey !== trimmed) {
    issues.push('‚ùå SUPABASE_SERVICE_ROLE_KEY has leading/trailing spaces')
  } else {
    console.log('‚úÖ SUPABASE_SERVICE_ROLE_KEY exists (no spaces)')
  }
}

// Print results
console.log('\n' + '='.repeat(60) + '\n')

if (issues.length > 0) {
  console.log('‚ùå ISSUES FOUND:\n')
  issues.forEach(issue => console.log(`  ${issue}`))
  console.log('')
}

if (warnings.length > 0) {
  console.log('‚ö†Ô∏è  WARNINGS:\n')
  warnings.forEach(warning => console.log(`  ${warning}`))
  console.log('')
}

if (issues.length === 0 && warnings.length === 0) {
  console.log('‚úÖ All environment variables are correctly configured!\n')
} else if (issues.length === 0) {
  console.log('‚úÖ No critical issues found, but check warnings above.\n')
}

// Google OAuth Callback URL confirmation
console.log('üìã Google OAuth Callback URL Configuration:')
console.log('   Expected in Google Cloud Console:')
console.log('   http://localhost:3000/api/auth/callback/google')
console.log('')
console.log('   This is automatically generated by NextAuth.')
console.log('   Make sure this EXACT URL is in your Google OAuth 2.0 Client settings.\n')

process.exit(issues.length > 0 ? 1 : 0)

